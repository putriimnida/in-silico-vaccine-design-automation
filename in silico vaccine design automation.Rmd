---
title: "in silico vaccine design"
author: "Putri Ramadani"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Data Collection
## Load library
```{r}
library(rentrez)
library(Biostrings)
```

## Retrieve sequence from NCBI
```{r}
# Function to retrieve and save a sequence from NCBI given an accession number
retrieve_and_save_sequence <- function(accession_number) {
  cat("Starting retrieval for accession number:", accession_number, "\n")
  
  # Fetch the sequence data from NCBI
  # Make sure to adjust the db parameter according to the type of sequence
  sequence_data <- entrez_fetch(db = "protein",   # Changed to 'protein' if the accession number is for a protein
                                id = accession_number, 
                                rettype = "fasta", 
                                retmode = "text")
  
  if (nchar(sequence_data) == 0) {
    stop("No data retrieved. Check the accession number and internet connection.")
  }
  
  # Define the output FASTA file name
  fasta_file_name <- paste0(accession_number, "_sequence.fasta")
  
  # Save the sequence data to a FASTA file
  writeLines(sequence_data, fasta_file_name)
  cat("Sequence data has been saved to:", fasta_file_name, "\n")
  
  return(fasta_file_name)
}

# Main function to automate the sequence retrieval and save process
automate_sequence_retrieval <- function(accession_number) {
  cat("Automated sequence retrieval initiated for accession number:", accession_number, "\n")
  
  # Retrieve and save the sequence
  fasta_file <- retrieve_and_save_sequence(accession_number)
  
  cat("Automated sequence retrieval and saving completed.\n")
  return(fasta_file)
}

# Example usage with the specific accession number for Hemagglutinin
automate_sequence_retrieval("BAL61222.1")

```

# 2. Epitope Prediction (still error)
## Install the Reticulate Package: Ensure you have the {reticulate} package installed in R, which facilitates interoperability between Python and R.

```{r}
install.packages("reticulate")
```


```{r}
library(reticulate)
```


```{python}
import iedb
from Bio import SeqIO


fasta_file = "BAL61222.1_sequence.fasta"
fasta_sequences = SeqIO.parse(open(fasta_file, 'r'), 'fasta')
sequence_string = str(next(fasta_sequences).seq)  # Efficient way to get the first sequence

# Use the sequence_string for your analysis
print(sequence_string)

# Reading the fasta file generated by R
fasta_file = "BAL61222.1_sequence.fasta"  # make sure this matches the actual file name produced by R
fasta_sequences = SeqIO.parse(open(fasta_file, 'r'), 'fasta')
sequence_string = str(list(fasta_sequences)[0].seq)

# MHC Class I Peptide Binding Prediction
mhci_res = iedb.query_mhci_binding(
    method="recommended", 
    sequence=sequence_string[:9],  # Example: Use the first 9 amino acids
    allele="HLA-A*02:01", 
    length=9
)
print("MHC Class I Prediction Results:", mhci_res)

# Additional epitope predictions can follow a similar pattern

```

# 3. Vaccine Construct Design
## Goal: Selects top epitopes and combines them with appropriate linkers.

## Step 1: setup R environment for deep learning
```{r}
if (!require("keras")) {
  install.packages("keras")
}
if (!require("tensorflow")) {
  install.packages("tensorflow")
}

```
```{r}
library(keras)
library(tensorflow)
```


## Step 2: Data preparation
Prepare data by encoding the amino acid sequences of the epitopes into a format suitable for training a neural network. This could involve one-hot encoding or using an embedding layer.
```{r}
# Example function to convert amino acid sequences to one-hot encoded matrix
amino_acids <- c('A', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'K', 'L', 'M', 'N', 'P', 'Q', 'R', 'S', 'T', 'V', 'W', 'Y')
encode_sequence <- function(sequence) {
  sapply(amino_acids, function(x) as.integer(x == unlist(strsplit(sequence, ""))))
}

```


## Step 3: Model Building (still error)
This model could be used to understand patterns in sequences that lead to high immunogenicity.
```{r}
model <- keras_model_sequential() %>%
  layer_embedding(input_dim = 20, output_dim = 50, input_length = 50) %>%
  bidirectional(layer_lstm(units = 64, return_sequences = TRUE)) %>%
  layer_flatten() %>%
  layer_dense(units = 1, activation = 'sigmoid')

model %>% compile(
  loss = 'binary_crossentropy',
  optimizer = optimizer_rmsprop(),
  metrics = c('accuracy')
)

print(model)
```

## Step 4: Model Training
```{r}
# Assuming 'x_train' and 'y_train' are prepared
# 'x_train' is a list of encoded sequences, and 'y_train' is a vector of labels (0 or 1)

model %>% fit(x_train, y_train, epochs = 10, batch_size = 32, validation_split = 0.2)

```

## Step 5: Construct Assembly
Use the trained model to predict the immunogenic potential of various epitope and linker combinations and select the best performing sequences:
```{r}
# Predicting with the model
predictions <- model %>% predict_classes(new_data)

# Select top predictions
top_predictions <- new_data[predictions >= threshold,]
```

## Step 6: Evaluation and iteration
Evaluate the performance of your vaccine constructs using in silico methods or plan for experimental validation:
```{r}
# Example of evaluating model performance
evaluate(model, x_test, y_test)
```

Using the model predictions to design effective vaccine constructs.



# 4. Safety Assessments: allergenicity, autoimmunity, and toxicity predictions
AllergenFP algorithm
AllerTOP predictors
PREAL (Prediction of Allergenic Proteins)


# 5. Molecular Docking & Dynamics Simulations
Jupyter: visualize protein structure prediction data with Python and py3dmol
